# セキュリティチェックリスト

プルリクエストのセキュリティレビューで確認すべき項目を記載する。OWASP Top 10を参考に構成されている。

## 目次

1. [インジェクション攻撃](#1-インジェクション攻撃)
2. [認証の不備](#2-認証の不備)
3. [機密データの露出](#3-機密データの露出)
4. [XMLエンティティ参照（XXE）](#4-xmlエンティティ参照xxe)
5. [アクセス制御の不備](#5-アクセス制御の不備)
6. [セキュリティの設定ミス](#6-セキュリティの設定ミス)
7. [クロスサイトスクリプティング（XSS）](#7-クロスサイトスクリプティングxss)
8. [安全でないデシリアライゼーション](#8-安全でないデシリアライゼーション)
9. [既知の脆弱性を持つコンポーネント](#9-既知の脆弱性を持つコンポーネント)
10. [不十分なロギングと監視](#10-不十分なロギングと監視)

---

## 1. インジェクション攻撃

### 1.1 SQLインジェクション

**チェック項目:**
- [ ] ユーザー入力が直接SQLクエリに結合されていないか
- [ ] プリペアドステートメント（パラメータ化クエリ）を使用しているか
- [ ] ORMを使用している場合、生のクエリ実行部分が適切にエスケープされているか

**悪い例:**
```python
# 危険: SQLインジェクションの脆弱性
query = f"SELECT * FROM users WHERE username = '{username}'"
```

**良い例:**
```python
# 安全: パラメータ化クエリ
query = "SELECT * FROM users WHERE username = ?"
cursor.execute(query, (username,))
```

### 1.2 コマンドインジェクション

**チェック項目:**
- [ ] ユーザー入力が直接シェルコマンドに渡されていないか
- [ ] `os.system()`, `subprocess.call(shell=True)`等の危険な関数を使用していないか
- [ ] コマンド実行が必要な場合、入力値が適切にバリデーションされているか

**悪い例:**
```python
# 危険: コマンドインジェクションの脆弱性
os.system(f"ls {user_input}")
```

**良い例:**
```python
# 安全: リスト形式でコマンドを指定
subprocess.run(["ls", user_input])
```

### 1.3 LDAPインジェクション

**チェック項目:**
- [ ] LDAP特殊文字がエスケープされているか
- [ ] ユーザー入力がLDAPクエリに直接結合されていないか

---

## 2. 認証の不備

### 2.1 パスワード管理

**チェック項目:**
- [ ] パスワードがハッシュ化されて保存されているか（平文保存していないか）
- [ ] 適切なハッシュアルゴリズム（bcrypt, Argon2等）を使用しているか
- [ ] パスワードがログに出力されていないか
- [ ] パスワードリセット機能が適切に実装されているか

**悪い例:**
```python
# 危険: 平文パスワードの保存
user.password = request.POST['password']
```

**良い例:**
```python
# 安全: bcryptでハッシュ化
import bcrypt
hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
```

### 2.2 セッション管理

**チェック項目:**
- [ ] セッションIDが予測不可能か
- [ ] ログイン後にセッションIDが再生成されているか
- [ ] セッションタイムアウトが適切に設定されているか
- [ ] ログアウト時にセッションが適切に破棄されているか

### 2.3 多要素認証（MFA）

**チェック項目:**
- [ ] 重要な操作にMFAが実装されているか（該当する場合）
- [ ] MFAのバイパスが可能な脆弱性がないか

---

## 3. 機密データの露出

### 3.1 ハードコードされた認証情報

**チェック項目:**
- [ ] APIキー、パスワード、トークンがソースコードに直接記述されていないか
- [ ] 環境変数や設定ファイルから認証情報を読み込んでいるか
- [ ] 設定ファイルが`.gitignore`に追加されているか

**悪い例:**
```python
# 危険: ハードコードされたAPIキー
API_KEY = "sk-1234567890abcdef"
```

**良い例:**
```python
# 安全: 環境変数から読み込み
import os
API_KEY = os.getenv('API_KEY')
```

### 3.2 ログへの機密情報の記録

**チェック項目:**
- [ ] パスワード、トークン、個人情報がログに記録されていないか
- [ ] エラーメッセージに機密情報が含まれていないか

### 3.3 データの暗号化

**チェック項目:**
- [ ] 機密データが暗号化されて保存されているか
- [ ] HTTPS通信を使用しているか
- [ ] 適切な暗号化アルゴリズムを使用しているか（MD5, SHA1は非推奨）

---

## 4. XMLエンティティ参照（XXE）

**チェック項目:**
- [ ] XML入力を処理する際、外部エンティティの参照が無効化されているか
- [ ] XMLパーサーが安全な設定で使用されているか

**良い例:**
```python
# 安全: 外部エンティティを無効化
from lxml import etree
parser = etree.XMLParser(resolve_entities=False)
```

---

## 5. アクセス制御の不備

### 5.1 認可チェック

**チェック項目:**
- [ ] すべての保護されたリソースに認可チェックがあるか
- [ ] ユーザーが自分のデータのみにアクセスできるよう制限されているか
- [ ] 管理者機能に適切なロールベースのアクセス制御があるか

**悪い例:**
```python
# 危険: ユーザーIDを検証せずにデータを返す
def get_user_data(user_id):
    return User.objects.get(id=user_id)
```

**良い例:**
```python
# 安全: 現在のユーザーと一致するか確認
def get_user_data(user_id, current_user):
    if user_id != current_user.id and not current_user.is_admin:
        raise PermissionDenied()
    return User.objects.get(id=user_id)
```

### 5.2 直接オブジェクト参照

**チェック項目:**
- [ ] URLパラメータに含まれるIDが適切に検証されているか
- [ ] 他ユーザーのリソースへの不正アクセスを防いでいるか

---

## 6. セキュリティの設定ミス

### 6.1 デバッグモード

**チェック項目:**
- [ ] 本番環境でデバッグモードが無効化されているか
- [ ] 詳細なエラーメッセージが本番環境で表示されていないか

### 6.2 デフォルト設定

**チェック項目:**
- [ ] デフォルトのパスワードやアカウントが変更されているか
- [ ] 不要なサービスやエンドポイントが無効化されているか

### 6.3 HTTPヘッダー

**チェック項目:**
- [ ] 適切なセキュリティヘッダーが設定されているか
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY` または `SAMEORIGIN`
  - `Content-Security-Policy`
  - `Strict-Transport-Security` (HTTPS使用時)

---

## 7. クロスサイトスクリプティング（XSS）

### 7.1 入力のサニタイゼーション

**チェック項目:**
- [ ] ユーザー入力がHTMLに出力される前にエスケープされているか
- [ ] テンプレートエンジンの自動エスケープ機能が有効化されているか
- [ ] `innerHTML`等の危険なDOM操作を避けているか

**悪い例:**
```javascript
// 危険: XSSの脆弱性
element.innerHTML = userInput;
```

**良い例:**
```javascript
// 安全: テキストとして挿入
element.textContent = userInput;
```

### 7.2 CSP（Content Security Policy）

**チェック項目:**
- [ ] CSPヘッダーが適切に設定されているか
- [ ] インラインスクリプトの使用を避けているか

---

## 8. 安全でないデシリアライゼーション

**チェック項目:**
- [ ] 信頼できないソースからのシリアライズされたデータを受け入れていないか
- [ ] `pickle`, `yaml.load()`等の危険なデシリアライゼーション関数を使用していないか

**悪い例:**
```python
# 危険: 任意のコード実行の可能性
import pickle
data = pickle.loads(user_input)
```

**良い例:**
```python
# 安全: JSONを使用
import json
data = json.loads(user_input)
```

---

## 9. 既知の脆弱性を持つコンポーネント

**チェック項目:**
- [ ] 依存ライブラリが最新版か、または既知の脆弱性がないか
- [ ] `npm audit`, `pip-audit`等のツールで脆弱性をチェックしているか
- [ ] 不要な依存関係が削除されているか

**確認方法:**
```bash
# Node.jsプロジェクト
npm audit

# Pythonプロジェクト
pip-audit

# Rubyプロジェクト
bundle audit
```

---

## 10. 不十分なロギングと監視

**チェック項目:**
- [ ] 重要なイベント（ログイン、パスワード変更、権限変更等）がログに記録されているか
- [ ] エラーやセキュリティイベントが適切にログに記録されているか
- [ ] ログに機密情報が含まれていないか
- [ ] ログが改ざんから保護されているか

**良い例:**
```python
# セキュリティイベントのログ記録
logger.info(f"Failed login attempt for user: {username} from IP: {ip_address}")
```

---

## 追加のセキュリティベストプラクティス

### CSRF対策

**チェック項目:**
- [ ] 状態を変更するリクエストにCSRFトークンが使用されているか
- [ ] SameSite Cookie属性が適切に設定されているか

### レート制限

**チェック項目:**
- [ ] API呼び出しにレート制限が実装されているか
- [ ] ブルートフォース攻撃を防ぐ仕組みがあるか

### ファイルアップロード

**チェック項目:**
- [ ] アップロードされるファイルの種類が制限されているか
- [ ] ファイルサイズの上限が設定されているか
- [ ] ファイル名が適切にサニタイズされているか
- [ ] アップロードされたファイルが実行可能領域に保存されていないか

---

## リスクレベルの評価

各脆弱性に対して、以下の基準でリスクレベルを評価する：

- **高**: 機密データの漏洩、任意のコード実行、認証のバイパス等
- **中**: 限定的な情報漏洩、一部機能の不正使用等
- **低**: 情報開示のみ、影響範囲が限定的な問題等
